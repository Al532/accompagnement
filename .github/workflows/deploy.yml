name: Sync branches into test and deploy

on:
  push:
    branches-ignore:
      - test
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-test
  cancel-in-progress: false

jobs:
  merge-and-deploy:
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: ${{ github.ref_name }}
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare test branch
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          git fetch origin main "$SOURCE_BRANCH"

          if git ls-remote --exit-code --heads origin test >/dev/null 2>&1; then
            git fetch origin test
            git checkout test
            git reset --hard origin/test
          else
            echo "Branch 'test' does not exist on origin. Creating from 'main'."
            git checkout -B test origin/main
            git push origin test
          fi

          git merge --no-ff --no-edit "origin/$SOURCE_BRANCH"
          git push origin test

      - name: Delete source branch
        if: success() && env.SOURCE_BRANCH != 'test' && env.SOURCE_BRANCH != env.DEFAULT_BRANCH
        run: |
          set -euo pipefail
          git push origin --delete "$SOURCE_BRANCH"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

    environment:
      name: test
      url: ${{ steps.deployment.outputs.page_url }}
